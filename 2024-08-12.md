---
layout: post
author: Gary Fuller
title: 12/08/2024
---
I've been suffering a fair bit of imposter syndrome recently and have thus been procrastinating more than I should. 

Today has been much more successful, however. I have made progress across the two main areas I was struggling with, proving the API controller was working, and creating the frontend controllers.

To assist with the frontend controllers, which rely on entities and forms, I looked at the registration controller generated by Symfony as well as [https://symfony.com/doc/6.4/controller.html](https://symfony.com/doc/6.4/controller.html), and [https://symfony.com/doc/6.4/doctrine.html#fetching-objects-from-the-database](https://symfony.com/doc/6.4/doctrine.html#fetching-objects-from-the-database). 

I broke the routes into index, show, and success. Index will list all of the emails associated with a campaign, and thus I'll need to work that out when I work on campaigns in more depth. An example of the code I created for a route is:

```php
    #[route('email/{id}/show', name: 'email_show')]
    public function show(Request $request, Email $email, EntityManagerInterface $entityManager, ApiController $apiController): Response
    {
        $user = new EmailUser();
        $form = $this->createForm(EmailUserFormType::class, $user);
        $form->handleRequest($request);
        if ($form->isSubmitted() && $form->isValid()) {
            $user->setCreateTime(new \DateTimeImmutable());
            $user->setEmailId($email);
            $entityManager->persist($user);
            $entityManager->flush();
            $request->getSession()->set('mp_data', $apiController->ApiRequest('postcode', $user->getPostcode())['response']['data']['0']);
            $request->getSession()->set('email_user', $user->getFirstName());
            return $this->redirectToRoute('email_success', ['id' => $email->getId()]);
        }
        return $this->render('email/show.html.twig', [
            'email' => $email,
            'form' => $form,
        ]);
    }
```

The associated Twig for the template is:

```twig
{% extends 'base.html.twig' %}
{% block title %}Email{% endblock %}
{% block body %}
    <h1>{{ email.getSubjectLine }}</h1>
    <div>{{ email.getEmailHtml | raw }}</div>
    <h1>Email Your MP</h1>
    {{ form_errors(form) }}
    {{ form_start(form) }}
        {{ form_row(form.first_name) }}
        {{ form_row(form.last_name) }}
        {{ form_row(form.email) }}
        {{ form_row(form.address_1) }}
        {{ form_row(form.address_2) }}
        {{ form_row(form.city) }}
        {{ form_row(form.county) }}
        {{ form_row(form.postcode) }}
        {{ form_row(form.ok_to_email) }}
        <button type="submit" class="btn">Send</button>
    {{ form_end(form) }}
{% endblock %}
```

I sought assistance from a colleague with the redirect query, as I need to pass data to the new page, and he put me onto Symfony's session storage. I looked at [https://symfony.com/doc/6.4/session.html](https://symfony.com/doc/6.4/session.html), which helped me to create code such as:

```php
$request->getSession()->set('mp_data', $apiController->ApiRequest('postcode', $user->getPostcode())['response']['data']['0']);
$request->getSession()->set('email_user', $user->getFirstName());
```

I created the email user form using the registration form and [https://symfony.com/doc/6.4/reference/forms/types.html](https://symfony.com/doc/6.4/reference/forms/types.html). I only really needed to specify what was added to the builder variable to make it work:

```php
    /**
     * Builds the form.
     *
     * @param FormBuilderInterface $builder The form builder
     * @param array<string, mixed> $options The options
     */
    public function buildForm(FormBuilderInterface $builder, array $options): void
    {
        $builder
            ->add('first_name')
            ->add('last_name')
            ->add('email')
            ->add('address_1')
            ->add('address_2')
            ->add('city')
            ->add('county')
            ->add('postcode')
            ->add('ok_to_email', CheckboxType::class)
        ;
    }
```

I've also had to significantly move around the tasks in Jira to reflect the fact that I should have better considered the order in which they would be created. I think I have Jira sorted now. We shall see.

Finally, I have made much more progress with the key area of research that I was unable to complete due to the GE, namely the questionnaire for potential users. I contacted anyone that has had access to the current service to ask them to complete the Google Form, with three people having done so within a few hours.
